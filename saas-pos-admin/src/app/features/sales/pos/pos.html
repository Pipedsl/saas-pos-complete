<p-toast position="top-center"></p-toast>

<div class="flex flex-col lg:flex-row h-[calc(100vh-5rem)] gap-4 p-2 overflow-hidden font-sans relative">

    <div class="flex-col gap-4 h-full lg:order-1 transition-all duration-300 flex-1 min-w-0" [ngClass]="{
            'hidden lg:flex': mobileView === 'CART', 
            'flex': mobileView === 'CATALOG'
         }">

        <div class="bg-cardbg p-3 rounded-xl shadow-lg border border-gray-200 dark:border-gray-800 flex gap-3 shrink-0">
            <button (click)="showScanner = true"
                class="bg-darkbg text-textmain px-4 rounded-lg border border-gray-700 hover:bg-gray-700 transition-colors flex items-center justify-center">
                <i class="pi pi-camera text-xl"></i>
            </button>
            <div class="relative flex-1 flex items-center">
                <div class="relative w-full">
                    <i class="pi pi-search absolute left-4 top-3 text-textsec text-lg"></i>
                    <input type="text"
                        class="w-full h-12 bg-darkbg text-textmain pl-12 pr-4 rounded-lg border border-gray-700 focus:border-primary focus:ring-2 outline-none transition-all"
                        placeholder="Escanear código o buscar producto..." [ngModel]="searchTerm"
                        (ngModelChange)="onSearch($event)" (keyup.enter)="onEnterSearch()" />
                    <button *ngIf="searchTerm" (click)="onSearch('')"
                        class="absolute right-3 top-3 text-textsec hover:text-textmain">
                        <i class="pi pi-times"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide w-full max-w-full">
            <button (click)="filterByCategory(null)"
                class="px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap border"
                [ngClass]="selectedCategoryId === null ? 'bg-darkbg text-textmain border-primary' : 'bg-cardbg text-textsec border-gray-700 hover:bg-gray-700'">
                Todas
            </button>

            <button *ngFor="let cat of categories" (click)="filterByCategory(cat.id)"
                class="px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap border"
                [ngClass]="selectedCategoryId === cat.id ? 'bg-darkbg text-textmain border-primary' : 'bg-cardbg text-textsec border-gray-700 hover:bg-gray-700'">
                {{ cat.name }}
            </button>
        </div>

        <div class="flex-1 overflow-y-auto pr-1 pb-24 lg:pb-0">
            <div *ngIf="visibleProducts.length === 0"
                class="h-64 flex flex-col items-center justify-center text-textsec">
                <i class="pi pi-box text-4xl mb-2"></i>
                <p>No se encontraron productos</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-2 lg:gap-3">
                <div *ngFor="let p of visibleProducts" (click)="selectProduct(p)"
                    [ngClass]="{'opacity-50 grayscale cursor-not-allowed': p.stockCurrent <= 0, 'hover:border-primary hover:dark:bg-gray-800 cursor-pointer': p.stockCurrent > 0}"
                    class="group bg-cardbg border border-gray-200 dark:border-gray-800 rounded-xl overflow-hidden shadow-sm hover:shadow-md transition-all active:scale-95 duration-200 flex flex-col h-auto relative">
                    <div class="absolute top-2 right-2 text-[10px] font-bold px-2 py-0.5 rounded-full z-10 shadow-sm backdrop-blur-md"
                        [ngClass]="p.stockCurrent <= 5 ? 'bg-red-500/90 text-white' : 'bg-emerald-500/90 text-white'">
                        {{ p.stockCurrent }}
                    </div>

                    <div class="w-full aspect-square bg-gray-100 dark:bg-gray-900 relative overflow-hidden">
                        <img [src]="p.imageUrl ? p.imageUrl : 'https://placehold.co/400x400/f3f4f6/9ca3af?text=Sin+Imagen'"
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500"
                            loading="lazy" alt="{{p.name}}">

                        <div
                            class="absolute bottom-0 left-0 bg-black/60 backdrop-blur-sm text-white text-[9px] px-2 py-1 rounded-tr-lg font-mono">
                            {{ p.sku }}
                        </div>
                    </div>

                    <div class="p-3 flex flex-col flex-1 gap-2">
                        <h3 class="text-textmain text-sm font-bold leading-tight line-clamp-2 h-10" title="{{p.name}}">
                            {{ p.name }}
                        </h3>

                        <div
                            class="flex justify-between items-center mt-auto pt-2 border-t border-gray-100 dark:border-gray-800">
                            <span *ngIf="p.measurementUnit === 'KG'"
                                class="text-[10px] font-bold bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-500 px-1.5 py-0.5 rounded">KG</span>
                            <span *ngIf="p.measurementUnit !== 'KG'"></span>
                            <p class="text-lg font-black text-primary leading-none">
                                {{ getPrice(p) | currency:'CLP':'symbol-narrow':'1.0-0' }}
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-cardbg rounded-xl shadow-2xl flex flex-col h-full border border-gray-200 dark:border-gray-800 overflow-hidden lg:order-2 transition-all duration-300 w-full lg:w-[35%] shrink-0 lg:min-w-[380px]"
        [ngClass]="{
            'hidden lg:flex': mobileView === 'CATALOG', 
            'flex': mobileView === 'CART'
         }">

        <div
            class="bg-darkbg p-3 text-textmain flex justify-between items-center border-b border-gray-200 dark:border-gray-800 shrink-0">
            <div class="flex items-center gap-2">
                <button (click)="toggleMobileView()" class="lg:hidden text-textsec hover:text-textmain mr-2">
                    <i class="pi pi-arrow-left text-xl"></i>
                </button>
                <h2 class="text-lg font-bold"><i class="pi pi-receipt mr-2"></i>Ticket</h2>
            </div>
            <button (click)="clearCart()"
                class="text-xs text-red-300 hover:text-textmain bg-red-900/30 px-2 py-1 rounded transition-colors">
                <i class="pi pi-trash mr-1"></i>Limpiar
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 bg-darkbg flex flex-col relative">

            <div *ngIf="(cartItems$ | async)?.length" class="space-y-2 pb-4">
                <div *ngFor="let item of cartItems$ | async"
                    class="bg-cardbg p-3 rounded-lg border border-gray-700 shadow-sm flex justify-between items-center transition-all">

                    <div class="flex-1 min-w-0 mr-3">
                        <div class="font-bold text-textmain text-sm truncate">{{ item.product.name }}</div>
                        <div class="text-xs text-textsec mt-1">
                            {{ item.unitPrice | currency:'CLP':'symbol-narrow':'1.0-0' }}
                            <span class="font-bold">/ {{ item.product.measurementUnit === 'KG' ? 'kg' : 'un' }}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div
                            class="flex items-center border border-gray-600 rounded bg-darkbg shadow-sm h-8 overflow-hidden">
                            <button (click)="decreaseItem(item.product.id)"
                                class="w-8 h-full text-red-500 hover:bg-red-500/10 font-bold flex items-center justify-center transition-colors">-</button>
                            <span
                                class="px-2 font-mono font-black text-sm text-textmain bg-darkbg border-x border-gray-600 h-full flex items-center justify-center min-w-12">
                                {{ item.quantity | number:'1.0-3' }}
                            </span>
                            <button (click)="increaseItem(item)"
                                class="w-8 h-full text-secondary hover:bg-green-500/10 font-bold flex items-center justify-center transition-colors">+</button>
                        </div>

                        <div class="font-bold text-textmain text-sm min-w-16 text-right">
                            {{ item.subtotal | currency:'CLP':'symbol-narrow':'1.0-0' }}
                        </div>

                        <button (click)="deleteItem(item.product.id)"
                            class="text-textsec hover:text-red-500 transition-colors ml-1">
                            <i class="pi pi-times-circle text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div *ngIf="(cartItems$ | async)?.length === 0"
                class="absolute inset-0 flex flex-col items-center justify-center text-textsec opacity-60 pointer-events-none">
                <div class="bg-gray-800 p-6 rounded-full mb-4">
                    <i class="pi pi-shopping-bag text-5xl text-textsec"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-500">Carrito vacío</h3>
                <p class="text-xs text-textsec mt-1">Agrega productos para comenzar</p>
            </div>

        </div>

        <div class="bg-cardbg p-4 border-t border-gray-700 shrink-0 z-10 shadow-up">
            <div class="flex justify-between items-end mb-3">
                <span class="text-textsec text-sm font-bold uppercase tracking-wide">Total a Pagar</span>
                <span class="text-4xl font-black text-textmain">
                    {{ total$ | async | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </span>
            </div>
            <button (click)="initiateCheckout()"
                class="w-full bg-secondary hover:bg-green-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg shadow-green-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                COBRAR <i class="pi pi-arrow-right font-bold"></i>
            </button>
        </div>
    </div>

    <div *ngIf="mobileView === 'CATALOG'" class="lg:hidden absolute bottom-4 left-4 right-4 z-50">
        <button (click)="toggleMobileView()"
            class="w-full bg-cardbg text-textmain p-4 rounded-xl shadow-2xl flex justify-between items-center border border-gray-700 active:scale-95 transition-transform">
            <div class="flex items-center gap-3">
                <div
                    class="bg-darkbg text-textmain w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    {{ (cartItems$ | async)?.length }}
                </div>
                <span class="font-bold text-sm">Ver Carrito</span>
            </div>
            <span class="text-xl font-bold text-secondary">
                {{ total$ | async | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </span>
        </button>
    </div>

</div>

<p-dialog header="Escanear Producto" [(visible)]="showScanner" [modal]="true"
    [style]="{width: '90%', maxWidth: '400px'}" [closable]="true" (onHide)="showScanner = false"
    styleClass="bg-cardbg text-textmain border border-gray-200 dark:border-gray-800">
    <div *ngIf="showScanner" class="flex justify-center">
        <app-barcode-scanner (scanSuccess)="handleScan($event)"></app-barcode-scanner>
    </div>
</p-dialog>

<p-dialog [(visible)]="showQtyDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '90%', maxWidth: '400px'}"
    styleClass="bg-cardbg text-textmain border border-gray-200 dark:border-gray-800" [closable]="true"
    (onShow)="focusQtyInput()">

    <ng-template pTemplate="header">
        <span class="text-xl font-bold text-textmain">Agregar al Carrito</span>
    </ng-template>

    <div class="flex flex-col gap-6 py-4" *ngIf="selectedProduct">
        <div class="text-center border-b border-gray-700 pb-4">
            <h3 class="text-2xl font-bold text-primary mb-1">{{ selectedProduct.name }}</h3>
            <div class="mt-2 inline-block bg-darkbg px-3 py-1 rounded border border-gray-700 text-xs text-textsec">
                Stock: <span class="text-textmain font-bold">{{ selectedProduct.stockCurrent }}</span>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <label class="text-textsec text-sm text-center">
                Cantidad ({{ selectedProduct.measurementUnit === 'KG' ? 'Kilos' : 'Unidades' }})
            </label>
            <p-inputNumber #qtyInput [(ngModel)]="qtyToAdd" [min]="selectedProduct.measurementUnit === 'KG' ? 0.05 : 1"
                [max]="selectedProduct.stockCurrent" [showButtons]="true" buttonLayout="horizontal"
                spinnerMode="horizontal" [step]="selectedProduct.measurementUnit === 'KG' ? 0.1 : 1"
                decrementButtonClass="p-button-danger" incrementButtonClass="p-button-success"
                incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" locale="en-US"
                [minFractionDigits]="selectedProduct.measurementUnit === 'KG' ? 3 : 0"
                [maxFractionDigits]="selectedProduct.measurementUnit === 'KG' ? 3 : 0" [useGrouping]="false"
                inputStyleClass="text-center text-4xl font-bold bg-darkbg text-textmain border-gray-700 w-full h-16 focus:ring-0"
                styleClass="w-full" (keydown.enter)="confirmAddToCart()">
            </p-inputNumber>
        </div>

        <div class="flex justify-between items-center bg-darkbg p-4 rounded-lg border border-gray-700">
            <span class="text-textsec">Subtotal:</span>
            <span class="text-2xl font-bold text-secondary">
                {{ (getPrice(selectedProduct) * qtyToAdd) | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </span>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex gap-3 w-full pt-2">
            <button pButton label="Cancelar" (click)="showQtyDialog = false"
                class="p-button-outlined p-button-secondary flex-1"></button>
            <button pButton label="AGREGAR" (click)="confirmAddToCart()"
                class="p-button-primary flex-1 font-bold text-lg" icon="pi pi-check"></button>
        </div>
    </ng-template>
</p-dialog>

<p-dialog header="Finalizar Venta" [(visible)]="showPaymentDialog" [modal]="true"
    [style]="{width: '95%', maxWidth: '500px'}"
    styleClass="bg-cardbg text-textmain border border-gray-200 dark:border-gray-800">

    <div class="flex flex-col gap-6 pt-2">
        <div class="text-center">
            <p class="text-textsec text-sm uppercase tracking-wider">Total a Pagar</p>
            <p class="text-5xl font-black text-textmain mt-1">{{ currentTotal | currency:'CLP':'symbol-narrow':'1.0-0'
                }}</p>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <div (click)="paymentMethod = 'CASH'"
                [ngClass]="paymentMethod === 'CASH' ? 'bg-darkbg text-textmain border-primary' : 'bg-cardbg text-textsec border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-money-bill text-2xl mb-1"></i>
                <span class="text-sm font-bold">Efectivo</span>
            </div>
            <div (click)="paymentMethod = 'CARD'"
                [ngClass]="paymentMethod === 'CARD' ? 'bg-darkbg text-textmain border-primary' : 'bg-cardbg text-textsec border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-credit-card text-2xl mb-1"></i>
                <span class="text-sm font-bold">Tarjeta</span>
            </div>
            <div (click)="paymentMethod = 'TRANSFER'"
                [ngClass]="paymentMethod === 'TRANSFER' ? 'bg-darkbg text-textmain border-primary' : 'bg-cardbg text-textsec border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-send text-2xl mb-1"></i>
                <span class="text-sm font-bold">Transf.</span>
            </div>
        </div>

        <div *ngIf="paymentMethod === 'CASH'"
            class="bg-darkbg p-4 rounded-lg border border-gray-200 dark:border-gray-800 space-y-4">
            <div>
                <label class="text-textsec text-sm block mb-2">Monto Recibido</label>
                <p-inputNumber [(ngModel)]="amountReceived" mode="currency" currency="CLP" locale="es-CL"
                    (onInput)="calculateChange()" placeholder="$0"
                    inputStyleClass="w-full text-3xl font-bold bg-black text-textmain border-gray-700 text-right h-16 focus:ring-primary"
                    styleClass="w-full" (keydown.enter)="finalizeSale()">
                </p-inputNumber>
            </div>
            <div class="flex justify-between items-center border-t border-gray-700 pt-4">
                <span class="text-xl font-bold text-textsec">Vuelto:</span>
                <span class="text-3xl font-bold" [ngClass]="changeAmount >= 0 ? 'text-green-400' : 'text-red-500'">
                    {{ changeAmount | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </span>
            </div>
        </div>

        <div *ngIf="paymentMethod === 'CARD'"
            class="bg-blue-900/20 p-6 rounded-xl border border-blue-500/30 text-center">
            <i class="pi pi-check-circle text-4xl text-blue-400 mb-3"></i>
            <p class="text-blue-200 font-bold">Pago externo</p>
            <p class="text-xs text-blue-400 mt-2">Confirma cuando la transacción esté aprobada en el POS físico.</p>
        </div>

        <div *ngIf="paymentMethod === 'TRANSFER'"
            class="bg-darkbg p-4 rounded-xl border border-gray-700 text-center space-y-2">
            <p class="text-textsec text-sm">Transfiere a:</p>
            <div
                class="bg-black p-3 rounded border border-gray-200 dark:border-gray-800 text-left text-sm font-mono text-green-400">
                <p>Banco: {{ shopSettings.bankName }}</p>
                <p>Tipo: {{ shopSettings.accountType }}</p>
                <p>N°: {{ shopSettings.accountNumber }}</p>
                <p>RUT: {{ shopSettings.rut }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ shopSettings.email }}</p>
            </div>
            <p class="text-xs text-blue-300 mt-2">Confirma cuando recibas el comprobante.</p>
        </div>

        <button pButton label="CONFIRMAR PAGO" (click)="finalizeSale()"
            class="w-full p-button-success font-bold text-xl py-4 shadow-lg shadow-green-900/20"
            [disabled]="paymentMethod === 'CASH' && changeAmount < 0">
        </button>
    </div>
</p-dialog>