<p-toast position="top-center"></p-toast>

<div class="flex flex-col lg:flex-row h-[calc(100vh-5rem)] gap-4 p-2 overflow-hidden font-sans relative">

    <div class="flex-col gap-4 h-full lg:order-1 transition-all duration-300 flex-1 min-w-0" [ngClass]="{
            'hidden lg:flex': mobileView === 'CART', 
            'flex': mobileView === 'CATALOG'
         }">

        <div class="bg-cardbg p-3 rounded-xl shadow-lg border border-gray-800 flex gap-3 flex-shrink-0">
            <button (click)="showScanner = true"
                class="bg-gray-800 text-white px-4 rounded-lg border border-gray-700 hover:bg-gray-700 transition-colors flex items-center justify-center">
                <i class="pi pi-camera text-xl"></i>
            </button>
            <div class="relative flex-1 flex items-center">
                <div class="relative w-full">
                    <i class="pi pi-search absolute left-4 top-3 text-gray-400 text-lg"></i>
                    <input type="text"
                        class="w-full h-12 bg-gray-900 text-white pl-12 pr-4 rounded-lg border border-gray-700 focus:border-primary focus:ring-2 outline-none transition-all"
                        placeholder="Escanear código o buscar producto..." [ngModel]="searchTerm"
                        (ngModelChange)="onSearch($event)" (keyup.enter)="onEnterSearch()" />
                    <button *ngIf="searchTerm" (click)="onSearch('')"
                        class="absolute right-3 top-3 text-gray-400 hover:text-white">
                        <i class="pi pi-times"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="flex gap-2 overflow-x-auto pb-2 mb-2 scrollbar-hide w-full max-w-full">

            <button (click)="filterByCategory(null)"
                class="px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap border"
                [ngClass]="selectedCategoryId === null ? 'bg-primary text-white border-primary' : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700'">
                Todas
            </button>

            <button *ngFor="let cat of categories" (click)="filterByCategory(cat.id)"
                class="px-4 py-2 rounded-full text-sm font-bold transition-all whitespace-nowrap border"
                [ngClass]="selectedCategoryId === cat.id ? 'bg-primary text-white border-primary' : 'bg-gray-800 text-gray-400 border-gray-700 hover:bg-gray-700'">
                {{ cat.name }}
            </button>
        </div>

        <div class="flex-1 overflow-y-auto pr-1 pb-24 lg:pb-0">

            <div *ngIf="visibleProducts.length === 0"
                class="h-64 flex flex-col items-center justify-center text-gray-500">
                <i class="pi pi-box text-4xl mb-2"></i>
                <p>No se encontraron productos</p>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-2 lg:gap-3">
                <div *ngFor="let p of visibleProducts" (click)="selectProduct(p)"
                    [ngClass]="{'opacity-50 grayscale cursor-not-allowed': p.stockCurrent <= 0, 'hover:border-primary hover:bg-gray-800 cursor-pointer': p.stockCurrent > 0}"
                    class="group bg-cardbg border border-gray-800 rounded-xl p-3 transition-all active:scale-95 duration-200 flex flex-col justify-between h-36 relative overflow-hidden">

                    <div class="absolute top-2 right-2 text-[10px] font-bold px-2 py-0.5 rounded z-10"
                        [ngClass]="p.stockCurrent <= 5 ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'">
                        {{ p.stockCurrent }}
                    </div>

                    <div>
                        <div class="text-[10px] font-mono text-gray-500 mb-1 truncate">{{ p.sku }}</div>
                        <h3 class="text-white text-xs font-medium leading-tight line-clamp-2 h-8">
                            {{ p.name }}
                        </h3>
                    </div>

                    <div class="mt-2 flex justify-between items-end">
                        <span *ngIf="p.measurementUnit === 'KG'"
                            class="text-[9px] bg-yellow-900/30 text-yellow-500 px-1 rounded">KG</span>
                        <p class="text-lg font-bold text-emerald-400">
                            {{ getPriceWithTax(p) | currency:'CLP':'symbol-narrow':'1.0-0' }}
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-2xl flex flex-col h-full border border-gray-200 overflow-hidden lg:order-2 transition-all duration-300 w-full lg:w-[35%] flex-shrink-0 lg:min-w-[380px]"
        [ngClass]="{
            'hidden lg:flex': mobileView === 'CATALOG', 
            'flex': mobileView === 'CART'
         }">

        <div
            class="bg-gray-900 p-3 text-white flex justify-between items-center border-b border-gray-800 flex-shrink-0">
            <div class="flex items-center gap-2">
                <button (click)="toggleMobileView()" class="lg:hidden text-gray-300 hover:text-white mr-2">
                    <i class="pi pi-arrow-left text-xl"></i>
                </button>
                <h2 class="text-lg font-bold"><i class="pi pi-receipt mr-2"></i>Ticket</h2>
            </div>
            <button (click)="clearCart()"
                class="text-xs text-red-300 hover:text-white bg-red-900/30 px-2 py-1 rounded transition-colors">
                <i class="pi pi-trash mr-1"></i>Limpiar
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-3 bg-gray-50 flex flex-col relative">

            <div *ngIf="(cartItems$ | async)?.length" class="space-y-2 pb-4">
                <div *ngFor="let item of cartItems$ | async"
                    class="bg-white p-3 rounded-lg border border-gray-200 shadow-sm flex justify-between items-center transition-all">

                    <div class="flex-1 min-w-0 mr-3">
                        <div class="font-bold text-gray-800 text-sm truncate">{{ item.product.name }}</div>
                        <div class="text-xs text-gray-500 mt-1">
                            {{ item.unitPrice | currency:'CLP':'symbol-narrow':'1.0-0' }}
                            <span class="font-bold">/ {{ item.product.measurementUnit === 'KG' ? 'kg' : 'un' }}</span>
                        </div>
                    </div>

                    <div class="flex items-center gap-2">
                        <div
                            class="flex items-center border border-gray-300 rounded bg-white shadow-sm h-8 overflow-hidden">
                            <button (click)="decreaseItem(item.product.id)"
                                class="w-8 h-full text-red-500 hover:bg-red-50 font-bold flex items-center justify-center transition-colors">-</button>
                            <span
                                class="px-2 font-mono font-black text-sm text-gray-900 bg-gray-50 border-x border-gray-200 h-full flex items-center justify-center min-w-[3rem]">
                                {{ item.quantity | number:'1.0-3' }}
                            </span>
                            <button (click)="increaseItem(item)"
                                class="w-8 h-full text-green-600 hover:bg-green-50 font-bold flex items-center justify-center transition-colors">+</button>
                        </div>

                        <div class="font-bold text-gray-900 text-sm min-w-[4rem] text-right">
                            {{ item.subtotal | currency:'CLP':'symbol-narrow':'1.0-0' }}
                        </div>

                        <button (click)="deleteItem(item.product.id)"
                            class="text-gray-400 hover:text-red-500 transition-colors ml-1">
                            <i class="pi pi-times-circle text-lg"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div *ngIf="(cartItems$ | async)?.length === 0"
                class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 opacity-60 pointer-events-none">
                <div class="bg-gray-200 p-6 rounded-full mb-4">
                    <i class="pi pi-shopping-bag text-5xl text-gray-400"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-500">Carrito vacío</h3>
                <p class="text-xs text-gray-400 mt-1">Agrega productos para comenzar</p>
            </div>

        </div>

        <div class="bg-white p-4 border-t border-gray-200 flex-shrink-0 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <div class="flex justify-between items-end mb-3">
                <span class="text-gray-500 text-sm font-bold uppercase tracking-wide">Total a Pagar</span>
                <span class="text-4xl font-black text-gray-900">
                    {{ total$ | async | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </span>
            </div>
            <button (click)="initiateCheckout()"
                class="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl text-xl shadow-lg shadow-emerald-500/30 active:scale-95 transition-all flex items-center justify-center gap-2">
                COBRAR <i class="pi pi-arrow-right font-bold"></i>
            </button>
        </div>
    </div>

    <div *ngIf="mobileView === 'CATALOG'" class="lg:hidden absolute bottom-4 left-4 right-4 z-50">
        <button (click)="toggleMobileView()"
            class="w-full bg-gray-900 text-white p-4 rounded-xl shadow-2xl flex justify-between items-center border border-gray-700 active:scale-95 transition-transform">
            <div class="flex items-center gap-3">
                <div
                    class="bg-primary text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">
                    {{ (cartItems$ | async)?.length }}
                </div>
                <span class="font-bold text-sm">Ver Carrito</span>
            </div>
            <span class="text-xl font-bold text-primary">
                {{ total$ | async | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </span>
        </button>
    </div>

</div>

<p-dialog header="Escanear Producto" [(visible)]="showScanner" [modal]="true"
    [style]="{width: '90%', maxWidth: '400px'}" [closable]="true" (onHide)="showScanner = false"
    styleClass="bg-cardbg text-white border border-gray-800">
    <div *ngIf="showScanner" class="flex justify-center">
        <app-barcode-scanner (scanSuccess)="handleScan($event)"></app-barcode-scanner>
    </div>
</p-dialog>

<p-dialog [(visible)]="showQtyDialog" [modal]="true" [draggable]="false" [resizable]="false"
    [style]="{width: '90%', maxWidth: '400px'}" styleClass="bg-cardbg text-white border border-gray-800"
    [closable]="true" (onShow)="focusQtyInput()">

    <ng-template pTemplate="header">
        <span class="text-xl font-bold text-white">Agregar al Carrito</span>
    </ng-template>

    <div class="flex flex-col gap-6 py-4" *ngIf="selectedProduct">

        <div class="text-center border-b border-gray-800 pb-4">
            <h3 class="text-2xl font-bold text-primary mb-1">{{ selectedProduct.name }}</h3>
            <div class="mt-2 inline-block bg-gray-800 px-3 py-1 rounded border border-gray-700 text-xs text-gray-300">
                Stock: <span class="text-white font-bold">{{ selectedProduct.stockCurrent }}</span>
            </div>
        </div>

        <div class="flex flex-col gap-2">
            <label class="text-gray-400 text-sm text-center">
                Cantidad ({{ selectedProduct.measurementUnit === 'KG' ? 'Kilos' : 'Unidades' }})
            </label>

            <p-inputNumber #qtyInput [(ngModel)]="qtyToAdd" [min]="0.001" [max]="selectedProduct.stockCurrent"
                [showButtons]="true" buttonLayout="horizontal" spinnerMode="horizontal"
                [step]="selectedProduct.measurementUnit === 'KG' ? 0.100 : 1" decrementButtonClass="p-button-danger"
                incrementButtonClass="p-button-success" incrementButtonIcon="pi pi-plus"
                decrementButtonIcon="pi pi-minus" locale="en-US" [minFractionDigits]="3" [maxFractionDigits]="3"
                [useGrouping]="false"
                inputStyleClass="text-center text-4xl font-bold bg-gray-900 text-white border-gray-700 w-full h-16 focus:ring-0"
                styleClass="w-full" (keydown.enter)="confirmAddToCart()">
            </p-inputNumber>
        </div>

        <div class="flex justify-between items-center bg-gray-800 p-4 rounded-lg border border-gray-700">
            <span class="text-gray-400">Subtotal:</span>
            <span class="text-2xl font-bold text-emerald-400">
                {{ (getPriceWithTax(selectedProduct) * qtyToAdd) | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </span>
        </div>

    </div>

    <ng-template pTemplate="footer">
        <div class="flex gap-3 w-full pt-2">
            <button pButton label="Cancelar" (click)="showQtyDialog = false"
                class="p-button-outlined p-button-secondary flex-1"></button>
            <button pButton label="AGREGAR" (click)="confirmAddToCart()"
                class="p-button-primary flex-1 font-bold text-lg" icon="pi pi-check"></button>
        </div>

    </ng-template>

</p-dialog>

<p-dialog header="Finalizar Venta" [(visible)]="showPaymentDialog" [modal]="true"
    [style]="{width: '95%', maxWidth: '500px'}" styleClass="bg-cardbg text-white border border-gray-800">

    <div class="flex flex-col gap-6 pt-2">

        <div class="text-center">
            <p class="text-gray-400 text-sm uppercase tracking-wider">Total a Pagar</p>
            <p class="text-5xl font-black text-white mt-1">{{ currentTotal | currency:'CLP':'symbol-narrow':'1.0-0' }}
            </p>
        </div>

        <div class="grid grid-cols-3 gap-3">
            <div (click)="paymentMethod = 'CASH'"
                [ngClass]="paymentMethod === 'CASH' ? 'bg-primary text-white border-primary' : 'bg-gray-800 text-gray-400 border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-money-bill text-2xl mb-1"></i>
                <span class="text-sm font-bold">Efectivo</span>
            </div>
            <div (click)="paymentMethod = 'CARD'"
                [ngClass]="paymentMethod === 'CARD' ? 'bg-primary text-white border-primary' : 'bg-gray-800 text-gray-400 border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-credit-card text-2xl mb-1"></i>
                <span class="text-sm font-bold">Tarjeta</span>
            </div>
            <div (click)="paymentMethod = 'TRANSFER'"
                [ngClass]="paymentMethod === 'TRANSFER' ? 'bg-primary text-white border-primary' : 'bg-gray-800 text-gray-400 border-gray-700'"
                class="p-4 rounded-lg border-2 cursor-pointer flex flex-col items-center justify-center transition-all hover:bg-gray-700">
                <i class="pi pi-send text-2xl mb-1"></i>
                <span class="text-sm font-bold">Transf.</span>
            </div>
        </div>

        <div *ngIf="paymentMethod === 'CASH'" class="bg-gray-900 p-4 rounded-lg border border-gray-800 space-y-4">
            <div>
                <label class="text-gray-400 text-sm block mb-2">Monto Recibido</label>
                <p-inputNumber [(ngModel)]="amountReceived" mode="currency" currency="CLP" locale="es-CL"
                    (onInput)="calculateChange()" placeholder="$0"
                    inputStyleClass="w-full text-3xl font-bold bg-black text-white border-gray-700 text-right h-16 focus:ring-primary"
                    styleClass="w-full" (keydown.enter)="finalizeSale()">
                </p-inputNumber>
            </div>

            <div class="flex justify-between items-center border-t border-gray-700 pt-4">
                <span class="text-xl font-bold text-gray-300">Vuelto:</span>
                <span class="text-3xl font-bold" [ngClass]="changeAmount >= 0 ? 'text-green-400' : 'text-red-500'">
                    {{ changeAmount | currency:'CLP':'symbol-narrow':'1.0-0' }}
                </span>
            </div>
        </div>

        <div *ngIf="paymentMethod === 'CARD'"
            class="bg-blue-900/20 p-6 rounded-xl border border-blue-500/30 text-center">
            <i class="pi pi-check-circle text-4xl text-blue-400 mb-3"></i>
            <p class="text-blue-200 font-bold">Pago externo</p>
            <p class="text-xs text-blue-400 mt-2">Confirma cuando la transacción esté aprobada en el POS físico.</p>
        </div>

        <div *ngIf="paymentMethod === 'TRANSFER'"
            class="bg-gray-900 p-4 rounded-xl border border-gray-700 text-center space-y-2">
            <p class="text-gray-400 text-sm">Transfiere a:</p>
            <div class="bg-black p-3 rounded border border-gray-800 text-left text-sm font-mono text-green-400">
                <p>Banco: {{ shopSettings.bankName }}</p>
                <p>Tipo: {{ shopSettings.accountType }}</p>
                <p>N°: {{ shopSettings.accountNumber }}</p>
                <p>RUT: {{ shopSettings.rut }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ shopSettings.email }}</p>
            </div>
            <p class="text-xs text-blue-300 mt-2">Confirma cuando recibas el comprobante.</p>
        </div>

        <button pButton label="CONFIRMAR PAGO" (click)="finalizeSale()"
            class="w-full p-button-success font-bold text-xl py-4 shadow-lg shadow-green-900/20"
            [disabled]="paymentMethod === 'CASH' && changeAmount < 0">
        </button>
    </div>
</p-dialog>

<!-- <div #ticketContent *ngIf="lastSaleTicket" style="display: none;">

    <div class="text-center font-bold text-sm mb-2">
        <h3>MI NEGOCIO</h3>
        <p>RUT: 76.xxx.xxx-x</p>
        <p>Ticket #{{ lastSaleTicket.saleNumber }}</p>
        <p>{{ lastSaleTicket.createdAt | date:'dd/MM/yy HH:mm' }}</p>
    </div>

    <hr style="border-top: 1px dashed black; margin: 5px 0;" />

    <div *ngFor="let item of lastSaleTicket.items" class="flex justify-between text-xs mb-1"
        style="display: flex; justify-content: space-between; margin-bottom: 4px;">
        <span>{{ item.quantity }} x {{ item.product.name | slice:0:15 }}</span>
        <span>{{ item.subtotal | currency:'CLP':'$':'1.0-0' }}</span>
    </div>

    <hr style="border-top: 1px dashed black; margin: 5px 0;" />

    <div class="flex justify-between font-bold text-sm"
        style="display: flex; justify-content: space-between; font-weight: bold;">
        <span>TOTAL</span>
        <span>{{ lastSaleTicket.total | currency:'CLP':'$':'1.0-0' }}</span>
    </div>

    <div *ngIf="lastSaleTicket.paymentMethod === 'CASH'" style="margin-top: 4px;">
        <div class="flex justify-between text-xs" style="display: flex; justify-content: space-between;">
            <span>Efectivo</span>
            <span>{{ (lastSaleTicket.total + lastSaleTicket.change) | currency:'CLP':'$':'1.0-0' }}</span>
        </div>
        <div class="flex justify-between text-xs" style="display: flex; justify-content: space-between;">
            <span>Vuelto</span>
            <span>{{ lastSaleTicket.change | currency:'CLP':'$':'1.0-0' }}</span>
        </div>
    </div>

    <div class="text-center text-[10px] mt-4" style="text-align: center; margin-top: 10px; font-size: 10px;">
        <p>¡Gracias por su compra!</p>
    </div>
</div> -->